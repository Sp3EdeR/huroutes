<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <title>huroutes | Helyjelölő link készítése</title>
  
  <link rel="icon" href="res/favicon.ico" />
  <link rel="icon" href="res/favicon.png" sizes="32x32" type="image/png" />
  <link rel="icon" href="res/favicon-sm.png" sizes="16x16" type="image/png" />

  <script>
    function parseGeo(str) {
      const round6 = n => Number(Number(n).toFixed(6))
      const geoParse = /\s*(-?[0-9\.]+)\s*,\s*(-?[0-9\.]+)\s*/;
      let match = geoParse.exec(str);
      if (match === null)
      {
        window.alert('Hibás geokoordináta formátum!\nA Google Maps által adott tizedes számos formátummal kell megadni\nPéldául: "47.654321,19.123456".');
        throw 'parse error';
      }
      return [round6(match[1]), round6(match[2])];
    }
    function makeLink() {
      function encode(str) {
        return encodeURI(str).replace(/\)/g, '%29').replace(/&/g, '%26');
      }
      data = {
        title: document.getElementById('title').value.trim(),
        geo: parseGeo(document.getElementById('geo').value),
        desc: document.getElementById('desc').value.trim()
      };
      var result = `#geo:${encode(data.title)}@${data.geo[0]},${data.geo[1]}`;
      if (data.desc)
        result += `/?b=${encode(data.desc)}`
      document.getElementById('link').value = result;
      document.getElementById('link').focus();
      document.execCommand('copy');
      return false;
    }
    function parseLink() {
      const re = /#geo:([^@]+)@(-?[0-9\\.]+),(-?[0-9\\.]+)(?:\/(?:[?&](?:b=([^&]+)))*)?/;
      m = re.exec(document.getElementById('link').value);
      if (m === null)
      {
        window.alert('Hibás link formátum!');
        throw 'parse error';
      }
      document.getElementById('title').value = decodeURI(m[1]);
      document.getElementById('geo').value = `${m[2]}, ${m[3]}`;
      document.getElementById('desc').value = decodeURI(m[4] ?? "");
    }
  </script>
</head>
<body>
  <h1>Helyjelölő link készítése</h1>
    <p><label for="title">Cím (csak sima szöveg):</label><br/><input type="text" id="title" maxLength="50" size="40"></p>
    <p><label for="geo">Geokoordináta (mint a Google koordináta):</label><br/><input type="text" id="geo" maxLength="40" size="40"></p>
    <p><label for="desc">Leírás (<a href="https://github.com/showdownjs/showdown/wiki/Showdown's-Markdown-syntax" tabindex="-1">Markdown szintaxis</a>):</label><br/><textarea id="desc" rows="20" style="width:100%"></textarea></p>
    <p><input type="submit" value="Link Készítése" onclick="return makeLink()"> <input type="submit" value="Link Visszafejtése" onclick="return parseLink()"></p>
    <p><label for="result">Link:</label><input type="text" id="link" style="width: 100%" onfocus="this.select();"></p>
  </div>
</body>
</html>